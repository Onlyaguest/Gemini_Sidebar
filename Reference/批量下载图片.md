// ==UserScript==
// @name         Gemini æ‰¹é‡å›¾ç‰‡ä¸‹è½½å™¨ (V6.0 å¹¶è¡Œæé€Ÿç‰ˆ)
// @namespace    http://tampermonkey.net/
// @version      6.0
// @description  (Trusted Types å…¼å®¹) å¢åŠ å¹¶è¡Œä¸‹è½½æ”¯æŒã€‚æ ‡å‡†æ¨¡å¼ä¿æŒæ¨¡æ‹Ÿç‚¹å‡»ä»¥è·å–å®˜æ–¹åŸå›¾ï¼›å¤‡ç”¨æ¨¡å¼å‡çº§ä¸ºå¤šçº¿ç¨‹å¹¶è¡Œä¸‹è½½ï¼Œå¤§å¹…æå‡æ‰¹é‡ä¸‹è½½é€Ÿåº¦ã€‚
// @author       Gemini Assistant
// @match        https://gemini.google.com/*
// @match        https://aistudio.google.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=google.com
// @grant        GM_download
// @grant        GM_notification
// ==/UserScript==

(function() {
    'use strict';

    // === é…ç½® ===
    const CONFIG = {
        minDelay: 2000, // æ ‡å‡†æ¨¡å¼ç‚¹å‡»é—´éš”
        maxDelay: 4000,
        maxConcurrent: 3, // å¹¶è¡Œä¸‹è½½çš„æœ€å¤§å¹¶å‘æ•° (å»ºè®® 3-5)
        prefix: 'gemini_img_'
    };
    
    // === æ ¸å¿ƒå·¥å…·ï¼šè·å–å¤‡ç”¨é«˜æ¸…é“¾æ¥ ===
    const getFallbackUrl = (src) => {
        try {
            if (src.includes('googleusercontent.com') && !src.includes('/rd-gg/')) {
                const baseUrl = src.split('=')[0];
                return baseUrl + '=s0';
            }
        } catch (e) {}
        return src;
    };
    
    // === æ ¸å¿ƒé€»è¾‘ï¼šæ‰«æå®˜æ–¹æŒ‰é’® ===
    const scanImages = () => {
        const resultList = [];
        const downloadButtons = document.querySelectorAll('button[data-test-id="download-generated-image-button"]');
    
        downloadButtons.forEach((btn, index) => {
            let container = btn.parentElement;
            let previewSrc = null;
    
            for (let i = 0; i < 6; i++) {
                if (!container) break;
                const imgs = container.querySelectorAll('img');
                for (let img of imgs) {
                    if (img.naturalWidth > 150 && img.naturalHeight > 150) {
                        previewSrc = img.src;
                        break;
                    }
                }
                if (previewSrc) break;
                container = container.parentElement;
            }
    
            const finalPreviewSrc = previewSrc || 'https://www.gstatic.com/images/branding/product/2x/gemini_gradient_icon_48dp.png';
    
            resultList.push({
                id: index,
                button: btn,
                previewUrl: finalPreviewSrc,
                fallbackUrl: getFallbackUrl(finalPreviewSrc)
            });
        });
    
        return resultList;
    };
    
    // === UI è¾…åŠ©å‡½æ•° ===
    const setBtnContent = (btn, icon, text) => {
        if (!btn) return;
        while (btn.firstChild) btn.removeChild(btn.firstChild);
        const iconSpan = document.createElement('span');
        iconSpan.textContent = icon;
        iconSpan.style.fontSize = '16px';
        iconSpan.style.marginRight = '6px';
        const textNode = document.createTextNode(text);
        btn.appendChild(iconSpan);
        btn.appendChild(textNode);
    };
    
    // === é¢„è§ˆä¸é€‰æ‹©é¢æ¿ ===
    const createSelectionPanel = (items, onConfirm) => {
        const oldModal = document.querySelector('.gemini-dl-modal');
        if(oldModal) document.body.removeChild(oldModal);
    
        const modal = document.createElement('div');
        modal.className = 'gemini-dl-modal';
    
        const panel = document.createElement('div');
        panel.className = 'gemini-dl-panel';
    
        const header = document.createElement('div');
        header.className = 'gemini-dl-header';
    
        const h3 = document.createElement('h3');
        h3.style.margin = '0';
        h3.textContent = `ç¡®è®¤ä¸‹è½½ (${items.length} å¼ )`;
    
        // === å¤‡ç”¨/å¹¶è¡Œæ–¹æ¡ˆå¼€å…³ ===
        const optionsDiv = document.createElement('div');
        optionsDiv.style.marginTop = '10px';
        optionsDiv.style.padding = '8px';
        optionsDiv.style.background = '#e8f0fe'; // æµ…è“è‰²èƒŒæ™¯çªå‡º
        optionsDiv.style.borderRadius = '6px';
        optionsDiv.style.fontSize = '13px';
        optionsDiv.style.border = '1px solid #d2e3fc';
    
        const fallbackLabel = document.createElement('label');
        fallbackLabel.style.display = 'flex';
        fallbackLabel.style.alignItems = 'center';
        fallbackLabel.style.cursor = 'pointer';
    
        const fallbackCheckbox = document.createElement('input');
        fallbackCheckbox.type = 'checkbox';
        fallbackCheckbox.id = 'gemini-fallback-mode';
        fallbackCheckbox.style.marginRight = '8px';
    
        const fallbackText = document.createElement('span');
        const b = document.createElement('b');
        b.textContent = 'ğŸš€ å¤‡ç”¨/æé€Ÿæ¨¡å¼ (å¹¶è¡Œä¸‹è½½)';
        b.style.color = '#1967d2';
    
        const br = document.createElement('br');
        const smallText = document.createElement('span');
        smallText.style.color = '#666';
        smallText.style.fontSize = '12px';
        smallText.textContent = 'æ¨èï¼ç»•è¿‡æµè§ˆå™¨æ‹¦æˆªï¼Œå¤šå¼ å›¾ç‰‡åŒæ—¶ä¸‹è½½ï¼Œé€Ÿåº¦æ›´å¿«ã€‚';
    
        fallbackText.appendChild(b);
        fallbackText.appendChild(br);
        fallbackText.appendChild(smallText);
    
        fallbackLabel.appendChild(fallbackCheckbox);
        fallbackLabel.appendChild(fallbackText);
        optionsDiv.appendChild(fallbackLabel);
    
        header.appendChild(h3);
        header.appendChild(optionsDiv);
    
        const content = document.createElement('div');
        content.className = 'gemini-dl-content';
    
        const checkboxes = [];
    
        items.forEach((item) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'gemini-dl-item selected';
            const img = document.createElement('img');
            img.src = item.previewUrl;
            const checkMark = document.createElement('div');
            checkMark.className = 'gemini-dl-checkbox';
            checkMark.textContent = 'âœ“';
    
            const testBtn = document.createElement('button');
            testBtn.className = 'gemini-dl-test-btn';
            testBtn.textContent = 'ğŸ‘† å•å¼ æµ‹è¯•';
            testBtn.onclick = (e) => {
                e.stopPropagation();
                if (item.button) {
                    item.button.scrollIntoView({behavior: "smooth", block: "center"});
                    setTimeout(() => item.button.click(), 500);
                    testBtn.textContent = 'å·²è§¦å‘';
                }
            };
    
            wrapper.onclick = (e) => {
                if(e.target === testBtn) return;
                wrapper.classList.toggle('selected');
            };
    
            wrapper.appendChild(img);
            wrapper.appendChild(checkMark);
            wrapper.appendChild(testBtn);
            content.appendChild(wrapper);
            checkboxes.push({ wrapper, item });
        });
    
        const footer = document.createElement('div');
        footer.className = 'gemini-dl-footer';
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.className = 'gemini-dl-btn-secondary';
        cancelBtn.onclick = () => document.body.removeChild(modal);
    
        const confirmBtn = document.createElement('button');
        confirmBtn.textContent = 'å¼€å§‹æ‰¹é‡ä¸‹è½½';
        confirmBtn.className = 'gemini-dl-btn-primary';
        confirmBtn.onclick = () => {
            const selectedItems = checkboxes
                .filter(c => c.wrapper.classList.contains('selected'))
                .map(c => c.item);
    
            if (selectedItems.length === 0) return alert('è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ ï¼');
    
            const useFallback = document.getElementById('gemini-fallback-mode').checked;
            modal.style.opacity = '0.8';
            modal.style.transform = 'scale(0.9)';
    
            // æ ¹æ®æ¨¡å¼é€‰æ‹©ä¸åŒçš„å¤„ç†é˜Ÿåˆ—
            if (useFallback) {
                processQueueParallel(selectedItems, () => document.body.removeChild(modal));
            } else {
                processQueueSerial(selectedItems, () => document.body.removeChild(modal));
            }
        };
    
        footer.appendChild(cancelBtn);
        footer.appendChild(confirmBtn);
        panel.appendChild(header);
        panel.appendChild(content);
        panel.appendChild(footer);
        modal.appendChild(panel);
        document.body.appendChild(modal);
    };
    
    // === æ¨¡å¼1: æ ‡å‡†ä¸²è¡Œ (æ¨¡æ‹Ÿç‚¹å‡») ===
    const processQueueSerial = async (items, onFinishCallback) => {
        const mainBtn = document.getElementById('gemini-dl-btn');
        let successCount = 0;
    
        try {
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                setBtnContent(mainBtn, 'â³', `æ¨¡æ‹Ÿç‚¹å‡» ${i + 1}/${items.length}`);
    
                try {
                    if (!item.button.isConnected) throw new Error("Button detached");
                    item.button.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    await new Promise(r => setTimeout(r, 800));
    
                    if (item.button && !item.button.disabled) {
                        item.button.click();
                        successCount++;
                    }
                } catch (e) {
                    console.warn(`[Gemini DL] ç‚¹å‡»å¤±è´¥: ${e.message}`);
                }
    
                const randomDelay = Math.floor(Math.random() * (CONFIG.maxDelay - CONFIG.minDelay + 1)) + CONFIG.minDelay;
                await new Promise(r => setTimeout(r, randomDelay));
            }
        } finally {
            setBtnContent(mainBtn, 'âœ…', `å®Œæˆ (${successCount}/${items.length})`);
            if (onFinishCallback) onFinishCallback();
            setTimeout(() => setBtnContent(mainBtn, 'â¬‡ï¸', 'ä¸‹è½½å›¾ç‰‡'), 3000);
        }
    };
    
    // === æ¨¡å¼2: å¹¶è¡Œæé€Ÿ (GM_download) ===
    const processQueueParallel = async (items, onFinishCallback) => {
        const mainBtn = document.getElementById('gemini-dl-btn');
        let completed = 0;
        let active = 0;
        let index = 0;
    
        // æ‰©å±•åæ¨æ–­
        const getExt = (url) => {
            if (url.includes('image/png') || url.includes('fmt=png')) return 'png';
            if (url.includes('image/jpeg') || url.includes('fmt=jpg')) return 'jpg';
            if (url.includes('image/webp') || url.includes('fmt=webp')) return 'webp';
            return 'jpg';
        };
    
        const updateStatus = () => {
            setBtnContent(mainBtn, 'ğŸš€', `å¹¶è¡Œä¸‹è½½: ${active}è¿›è¡Œ / ${items.length - completed}å‰©ä½™`);
        };
    
        // å•ä¸ªä¸‹è½½ä»»åŠ¡åŒ…è£…å™¨
        const startDownload = (item, idx) => {
            return new Promise((resolve) => {
                const ext = getExt(item.fallbackUrl);
                const filename = `${CONFIG.prefix}${String(idx + 1).padStart(2, '0')}.${ext}`;
    
                GM_download({
                    url: item.fallbackUrl,
                    name: filename,
                    saveAs: false,
                    onload: () => {
                        console.log(`[Gemini DL] å¹¶è¡Œä¸‹è½½æˆåŠŸ: ${idx + 1}`);
                        resolve();
                    },
                    onerror: (err) => {
                        console.error(`[Gemini DL] å¹¶è¡Œä¸‹è½½å¤±è´¥: ${idx + 1}`, err);
                        resolve(); // å¤±è´¥ä¸ä¸­æ–­
                    }
                });
            });
        };
    
        // ç®€å•çš„å¹¶å‘æ§åˆ¶å™¨
        const runPool = async () => {
            const promises = [];
            while (index < items.length) {
                if (active < CONFIG.maxConcurrent) {
                    const idx = index++;
                    const item = items[idx];
                    active++;
                    updateStatus();
    
                    const p = startDownload(item, idx).then(() => {
                        active--;
                        completed++;
                        updateStatus();
                    });
                    promises.push(p);
                } else {
                    // ç­‰å¾…ä»»æ„ä¸€ä¸ªå®Œæˆ
                    await Promise.race(promises.filter(p => p !== null));
                    // æ¸…ç†å·²å®Œæˆçš„ promise (ç®€åŒ–é€»è¾‘ï¼Œä¸åšä¸¥æ ¼æ¸…ç†)
                }
                // å¾®å°å»¶è¿Ÿé˜²æ­¢ CPU å ç”¨è¿‡é«˜
                await new Promise(r => setTimeout(r, 50));
            }
            // ç­‰å¾…å‰©ä½™ä»»åŠ¡
            await Promise.all(promises);
        };
    
        try {
            await runPool();
        } finally {
            setBtnContent(mainBtn, 'âœ…', `å¹¶è¡Œå®Œæˆ (${completed}/${items.length})`);
            if (onFinishCallback) onFinishCallback();
            setTimeout(() => setBtnContent(mainBtn, 'â¬‡ï¸', 'ä¸‹è½½å›¾ç‰‡'), 3000);
        }
    };
    
    // === æ ·å¼ ===
    const styles = `
        .gemini-dl-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10001; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(4px); transition: all 0.3s; }
        .gemini-dl-panel { background: white; width: 700px; max-width: 95vw; max-height: 85vh; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.4); font-family: sans-serif; }
        .gemini-dl-header { padding: 15px 20px; border-bottom: 1px solid #eee; background: #f8f9fa; border-radius: 12px 12px 0 0; }
        .gemini-dl-content { padding: 20px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .gemini-dl-item { position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; background: #eee; }
        .gemini-dl-item img { width: 100%; height: 100%; object-fit: cover; }
        .gemini-dl-item.selected { border-color: #1a73e8; box-shadow: 0 0 0 1px #1a73e8; }
        .gemini-dl-item:not(.selected) { opacity: 0.6; filter: grayscale(100%); }
        .gemini-dl-checkbox { position: absolute; top: 5px; right: 5px; width: 24px; height: 24px; background: #1a73e8; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; opacity: 0; transition: opacity 0.2s; }
        .gemini-dl-item.selected .gemini-dl-checkbox { opacity: 1; }
        .gemini-dl-test-btn { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); color: white; text-align: center; font-size: 12px; padding: 8px 0; border: none; cursor: pointer; transform: translateY(100%); transition: transform 0.2s; }
        .gemini-dl-item:hover .gemini-dl-test-btn { transform: translateY(0); }
        .gemini-dl-test-btn:hover { background: #1a73e8; }
        .gemini-dl-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; background: #fff; border-radius: 0 0 12px 12px; }
        .gemini-dl-btn-primary { background: #1a73e8; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; }
        .gemini-dl-btn-primary:hover { background: #1557b0; }
        .gemini-dl-btn-secondary { background: white; color: #5f6368; border: 1px solid #dadce0; padding: 10px 20px; border-radius: 20px; cursor: pointer; }
        #gemini-dl-btn { position: fixed; top: 12px; right: 180px; z-index: 10000; background-color: #1a73e8; color: white; border: none; border-radius: 8px; padding: 8px 16px; font-size: 14px; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; display: flex; align-items: center; transition: background-color 0.3s; }
        #gemini-dl-btn:hover { background-color: #1557b0; }
    `;
    
    if (!document.getElementById('gemini-dl-style')) {
        const styleSheet = document.createElement("style");
        styleSheet.id = 'gemini-dl-style';
        styleSheet.textContent = styles;
        document.head.appendChild(styleSheet);
    }
    
    const createButton = () => {
        const btn = document.createElement('button');
        btn.id = 'gemini-dl-btn';
        setBtnContent(btn, 'â¬‡ï¸', 'ä¸‹è½½å›¾ç‰‡');
    
        btn.onclick = (e) => {
            e.stopPropagation();
            const items = scanImages();
            if (items.length === 0) return alert("æœªæ‰¾åˆ°å®˜æ–¹ä¸‹è½½æŒ‰é’®ï¼Œè¯·æ»šåŠ¨é¡µé¢åŠ è½½å›¾ç‰‡ï¼");
            createSelectionPanel(items, (urls, useFallback, closePanel) => {
                if (useFallback) {
                    processQueueParallel(urls, closePanel);
                } else {
                    processQueueSerial(urls, closePanel);
                }
            });
        };
        return btn;
    };
    
    const daemon = setInterval(() => {
        if (!document.getElementById('gemini-dl-btn')) document.body.appendChild(createButton());
    }, 1500);
    
    console.log("[Gemini Downloader] V6.0 å¹¶è¡Œæé€Ÿç‰ˆå·²å¯åŠ¨");

})();